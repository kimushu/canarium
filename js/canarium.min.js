// ******************************************************************* //
// PERIDOT Chrome Apps driver - 'Canarium' (version 0.9.7)             //
// Copyright (C) 2015 @kimu_shu and @s_osafune                         //
// ------------------------------------------------------------------- //
// The original version of Canarium (below version 0.9.6) is written   //
// by @s_osafune and distributed under the following license:          //
//                                                                     //
//     Copyright (C) 2014, J-7SYSTEM Works.  All rights Reserved.      //
//                                                                     //
// * This module is a free sourcecode and there is NO WARRANTY.        //
// * No restriction on use. You can use, modify and redistribute it    //
//   for personal, non-profit or commercial products UNDER YOUR        //
//   RESPONSIBILITY.                                                   //
// * Redistributions of source code must retain the above copyright    //
//   notice.                                                           //
//                                                                     //
//         PERIDOT Project - https://github.com/osafune/peridot        //
// ******************************************************************* //
(function(){var Canarium,RELEASE_BUILD,TimeLimit,finallyPromise,hexDump,invokeCallback,oldProperty,tryPromise,waitPromise;RELEASE_BUILD=false;oldProperty=Function.prototype.property;Function.prototype.property=function(prop,desc){return Object.defineProperty(this.prototype,prop,desc)};hexDump=function(data,maxBytes){var brace,hex,i,len,r;brace=true;if(typeof data==="number"){brace=false;data=[data]}else if(data instanceof ArrayBuffer){data=new Uint8Array(data)}else if(data instanceof Uint8Array){null}else if(data instanceof Array){null}else{throw Error("Unsupported data type: "+data)}len=data.length;if(maxBytes!=null){len=Math.min(len,maxBytes)}hex=function(v){return"0x"+(v<16?"0":"")+((v!=null?typeof v.toString==="function"?v.toString(16):void 0:void 0)||"??")};r=function(){var j,ref,results;results=[];for(i=j=0,ref=len;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j){results.push(hex(data[i]))}return results}().join(",");if(data.length>len){r+="..."}if(brace){r="["+r+"]"}return r};invokeCallback=function(callback,promise){if(!callback){return promise}promise.then(function(value){callback(true,value)})["catch"](function(reason){callback(false,reason)})};waitPromise=function(dulation,value){return new Promise(function(resolve){return window.setTimeout(function(){return resolve(value)},dulation)})};tryPromise=function(timeout,promiser,maxTries){var count;count=0;return new Promise(function(resolve,reject){var lastReason,next;lastReason=void 0;window.setTimeout(function(){return reject(lastReason||Error("Operation timed out after "+count+" tries"))},timeout);next=function(){return promiser().then(function(value){return resolve(value)},function(reason){lastReason=reason;count++;if(maxTries!=null&&count>=maxTries){return reject(lastReason)}return next()})};return next()})};finallyPromise=function(action){return[function(value){action();return value},function(error){action();return Promise.reject(error)}]};if(!RELEASE_BUILD){Uint8Array.prototype.hexDump=function(){return hexDump(this)}}TimeLimit=function(){function TimeLimit(timeout1){this.timeout=timeout1;this.start=this.now;return}TimeLimit.property("now",{get:function(){return window.performance.now()}});TimeLimit.property("left",{get:function(){return Math.max(0,this.timeout-parseInt(this.now-this.start))}});return TimeLimit}();Canarium=function(){var AVM_CHANNEL,CONFIG_TIMEOUT_MS,EEPROM_SLAVE_ADDR,SPLIT_EEPROM_BURST;null;Canarium.property("version",{value:"0.9.7"});Canarium.property("boardInfo",{get:function(){return this._boardInfo}});Canarium.property("serialBitrate",{get:function(){return this._base.bitrate},set:function(v){return this._base.bitrate=v}});Canarium.property("channels",{get:function(){return this._channels}});Canarium.property("i2c",{get:function(){return this._i2c}});Canarium.property("avs",{get:function(){return this._avs}});Canarium.property("avm",{get:function(){return this._avm}});Canarium.verbosity=0;EEPROM_SLAVE_ADDR=80;SPLIT_EEPROM_BURST=6;CONFIG_TIMEOUT_MS=3e3;AVM_CHANNEL=0;Canarium.enumerate=function(callback){if(callback!=null){return invokeCallback(callback,this.enumerate())}return Canarium.BaseComm.enumerate()};function Canarium(){this._boardInfo=null;this._channels=null;this._base=new Canarium.BaseComm;this._i2c=new Canarium.I2CComm(this._base);this._avs=new Canarium.AvsPackets(this._base);this._avm=new Canarium.AvmTransactions(this._avs,AVM_CHANNEL);this._configBarrier=false;this._resetBarrier=false;return}Canarium.prototype.open=function(portname,callback){if(callback!=null){return invokeCallback(callback,this.open(portname))}return Promise.resolve().then(function(_this){return function(){return _this._base.connect(portname)}}(this)).then(function(_this){return function(){return Promise.resolve().then(function(){_this._boardInfo=null;_this._base.configured=false;return _this._eepromRead(0,4)}).then(function(readData){var header;header=new Uint8Array(readData);if(!(header[0]===74&&header[1]===55&&header[2]===87)){return Promise.reject(Error("EEPROM header is invalid"))}_this._log(1,"open","done(version="+hexDump(header[3])+")");_this._boardInfo={version:header[3]}})["catch"](function(error){return _this._base.disconnect()["catch"](function(){}).then(function(){return Promise.reject(error)})})}}(this))};Canarium.prototype.close=function(callback){if(callback!=null){return invokeCallback(callback,this.close())}return Promise.resolve().then(function(_this){return function(){return _this._base.disconnect()}}(this)).then(function(_this){return function(){_this._boardInfo=null;_this._base.configured=false}}(this))};Canarium.prototype.config=function(boardInfo,rbfdata,callback){var ref,timeLimit;if(callback!=null){return invokeCallback(callback,this.config(boardInfo,rbfdata))}if(this._configBarrier){return Promise.reject(Error("Configuration is now in progress"))}this._configBarrier=true;timeLimit=void 0;return(ref=Promise.resolve().then(function(_this){return function(){if(boardInfo||_this.boardInfo.id&&_this.boardInfo.serialcode){return}return _this.getinfo()}}(this)).then(function(_this){return function(){var mismatch;mismatch=function(a,b){return a&&a!==b};if(mismatch(boardInfo!=null?boardInfo.id:void 0,_this.boardInfo.id)){return Promise.reject(Error("Board ID mismatch"))}if(mismatch(boardInfo!=null?boardInfo.serialcode:void 0,_this.boardInfo.serialcode)){return Promise.reject(Error("Board serial code mismatch"))}}}(this)).then(function(_this){return function(){return _this._base.transCommand(59)}}(this)).then(function(_this){return function(response){if((response&1)!==0){return Promise.reject(Error("Not PS mode"))}}}(this)).then(function(_this){return function(){return timeLimit=new TimeLimit(CONFIG_TIMEOUT_MS)}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(50).then(function(response){if((response&6)!==0){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(51).then(function(response){if((response&6)!==2){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return _this._base.transData(rbfdata)}}(this)).then(function(_this){return function(){return _this._base.transCommand(51)}}(this)).then(function(_this){return function(response){if((response&6)!==6){return Promise.reject(Error("FPGA configuration failed"))}}}(this)).then(function(_this){return function(){return _this._base.transCommand(57)}}(this)).then(function(_this){return function(){_this._base.configured=true}}(this))).then.apply(ref,finallyPromise(function(_this){return function(){return _this._configBarrier=false}}(this)))};Canarium.prototype.reset=function(callback){var ref;if(callback!=null){return invokeCallback(callback,this.reset())}if(this._resetBarrier){return Promise.reject(Error("Reset is now in progress"))}this._resetBarrier=true;return(ref=Promise.resolve().then(function(_this){return function(){return _this._base.transCommand(49)}}(this)).then(function(_this){return function(){return waitPromise(100)}}(this)).then(function(_this){return function(){return _this._base.transCommand(57)}}(this)).then(function(_this){return function(response){return response}}(this))).then.apply(ref,finallyPromise(function(_this){return function(){return _this._resetBarrier=false}}(this)))};Canarium.prototype.getinfo=function(callback){if(callback!=null){return invokeCallback(callback,this.getinfo())}return Promise.resolve().then(function(_this){return function(){var ref;switch((ref=_this._boardInfo)!=null?ref.version:void 0){case void 0:return Promise.reject(Error("Boardinfo not loaded"));case 1:return _this._eepromRead(4,8).then(function(readData){var info,mid,pid,s,sid;info=new Uint8Array(readData);_this._log(1,"getinfo","ver1",info);mid=info[0]<<8|info[1]<<0;pid=info[2]<<8|info[3]<<0;sid=info[4]<<24|info[5]<<16|info[6]<<8|info[7]<<0;if(mid===114){s=""+pid.hex(4)+sid.hex(8);_this._boardInfo.id="J72A";return _this._boardInfo.serialcode=s.substr(0,6)+"-"+s.substr(6,6)+"-000000"}});case 2:return _this._eepromRead(4,22).then(function(readData){var bid,i,info,j,k,s;info=new Uint8Array(readData);_this._log(1,"getinfo","ver2",info);bid="";for(i=j=0;j<4;i=++j){bid+=String.fromCharCode(info[i])}s="";for(i=k=4;k<22;i=++k){s+=String.fromCharCode(info[i])}_this._boardInfo.id=""+bid;return _this._boardInfo.serialcode=s.substr(0,6)+"-"+s.substr(6,6)+"-"+s.substr(12,6)});case 10:return _this.avm.read(MAX10BOOT_SWI_BASE+8,8).then(function(readData){_this._log(1,"getinfo","ver10",readData);_this._boardInfo.id="MAX 10";return _this._boardInfo.serialcode="xxxxxxxx-xxxxxxxx"});default:return Promise.reject(Error("Unknown boardinfo version"))}}}(this)).then(function(_this){return function(){return _this.boardInfo}}(this))};Canarium.prototype.option=function(option,callback){if(callback!=null){return invokeCallback(callback,this.option(option))}return this._base.option(option)};Canarium.prototype._eepromRead=function(startaddr,readbytes){var array,lastError,x;array=new Uint8Array(readbytes);if(SPLIT_EEPROM_BURST!=null&&readbytes>SPLIT_EEPROM_BURST){return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=readbytes,ref1=SPLIT_EEPROM_BURST;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(_this){return function(sequence,offset){return sequence.then(function(){return _this._eepromRead(startaddr+offset,Math.min(SPLIT_EEPROM_BURST,readbytes-offset))}).then(function(partialData){array.set(new Uint8Array(partialData),offset)})}}(this),Promise.resolve()).then(function(_this){return function(){return array.buffer}}(this))}lastError=null;return Promise.resolve().then(function(_this){return function(){_this._log(1,"_eepromRead","begin(addr="+hexDump(startaddr)+",bytes="+hexDump(readbytes)+")");return _this.i2c.start()}}(this)).then(function(_this){return function(){return _this.i2c.write(EEPROM_SLAVE_ADDR<<1).then(function(ack){if(!ack){return Promise.reject(Error("EEPROM is not found."))}})}}(this)).then(function(_this){return function(){return _this.i2c.write(startaddr&255).then(function(ack){if(!ack){return Promise.reject(Error("Cannot write address in EEPROM"))}})}}(this)).then(function(_this){return function(){return _this.i2c.start()}}(this)).then(function(_this){return function(){return _this.i2c.write((EEPROM_SLAVE_ADDR<<1)+1).then(function(ack){if(!ack){return Promise.reject(Error("EEPROM is not found."))}})}}(this)).then(function(_this){return function(){var j,lastIndex,results;lastIndex=readbytes-1;return function(){results=[];for(var j=0;0<=lastIndex?j<=lastIndex:j>=lastIndex;0<=lastIndex?j++:j--){results.push(j)}return results}.apply(this).reduce(function(promise,index){return promise.then(function(){return _this.i2c.read(index!==lastIndex)}).then(function(byte){return array[index]=byte})},Promise.resolve())}}(this))["catch"](function(_this){return function(error){lastError=error}}(this)).then(function(_this){return function(){return _this.i2c.stop()}}(this)).then(function(_this){return function(){if(lastError){return Promise.reject(lastError)}_this._log(1,"_eepromRead","end",array);return array.buffer}}(this))};Canarium._log=function(cls,func,msg,data){var obj,out,time;if(typeof SUPPRESS_ALL_LOGS!=="undefined"&&SUPPRESS_ALL_LOGS!==null&&SUPPRESS_ALL_LOGS){return}time=window.performance.now().toFixed(3);out=(obj={time:time},obj[cls+"#"+func]=msg,obj.stack=(new Error).stack.split("\n    ").slice(1),obj);if(data){out.data=data}console.log(out)};Canarium.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("Canarium",func,msg,data)}};return Canarium}();Canarium.BaseComm=function(){var SERIAL_TX_MAX_LENGTH,SPLIT_EVENT_CONTEXT,SUCCESSIVE_TX_WAIT_MS;null;BaseComm.property("connected",{get:function(){return this._connected}});BaseComm.property("path",{get:function(){return this._path}});BaseComm.property("bitrate",{get:function(){return this._bitrate},set:function(v){return this._bitrate=parseInt(v)}});BaseComm.property("sendImmediate",{get:function(){return this._sendImmediate},set:function(v){return this._sendImmediate=!!v}});BaseComm.property("configured",{get:function(){return this._configured},set:function(v){return this._configured=!!v}});BaseComm.verbosity=2;SERIAL_TX_MAX_LENGTH=1024;SUCCESSIVE_TX_WAIT_MS=null;SPLIT_EVENT_CONTEXT=false;BaseComm.enumerate=function(){var getName;getName=function(port){var name,path;name=port.displayName;path=port.path;if(name){return name+" ("+path+")"}return""+path};return new Promise(function(_this){return function(resolve){return chrome.serial.getDevices(function(ports){var devices,j,len1,port;devices=[];for(j=0,len1=ports.length;j<len1;j++){port=ports[j];devices.push({path:""+port.path,name:getName(port)})}return resolve(devices)})}}(this))};function BaseComm(){this._connected=false;this._path=null;this._bitrate=115200;this._sendImmediate=false;this._configured=false;this._cid=null;this._onReceive=function(_this){return function(info){return _this._onReceiveHandler(info)}}(this);this._onReceiveError=function(_this){return function(info){return _this._onReceiveErrorHandler(info)}}(this);this._rxQueue=null;this._rxBuffers=null;this._rxTotalLength=null;this._rxBuffer=null;this._receiver=null;this._processor=Promise.resolve();return}BaseComm.prototype.connect=function(path){if(this._connected){return Promise.reject(Error("Already connected"))}this._connected=true;this._path=null;return new Promise(function(_this){return function(resolve,reject){return chrome.serial.connect(path,{bitrate:_this._bitrate},function(connectionInfo){if(!connectionInfo){_this._connected=false;return reject(Error(chrome.runtime.lastError))}_this._path=""+path;_this._cid=connectionInfo.connectionId;_this._rxQueue=[];_this._rxBuffers=[];_this._rxTotalLength=0;chrome.serial.onReceive.addListener(_this._onReceive);chrome.serial.onReceiveError.addListener(_this._onReceiveError);return resolve()})}}(this))};BaseComm.prototype.option=function(option){return Promise.resolve().then(function(_this){return function(){var value;if((value=option.fastAcknowledge)==null){return}_this._sendImmediate=value;return _this.transCommand(57|(value?2:0))}}(this)).then(function(_this){return function(){var value;if((value=option.forceConfigured)==null){return}return _this._configured=value}}(this)).then(function(_this){return function(){}}(this))};BaseComm.prototype.disconnect=function(){if(!this._connected){return Promise.reject(Error("Not connected"))}return new Promise(function(_this){return function(resolve,reject){return chrome.serial.disconnect(_this._cid,function(result){if(!result){return reject(Error(chrome.runtime.lastError))}chrome.serial.onReceive.removeListener(_this._onReceive);chrome.serial.onReceiveError.removeListener(_this._onReceiveError);_this._connected=false;_this._path=null;_this._cid=null;_this._rxQueue=null;_this._rxBuffers=null;_this._rxTotalLength=null;return resolve()})}}(this))};BaseComm.prototype.transCommand=function(command){var txarray;txarray=new Uint8Array(2);txarray[0]=58;txarray[1]=command;return this._transSerial(txarray.buffer,function(_this){return function(rxdata){if(!(rxdata.byteLength>=1)){return}return 1}}(this)).then(function(_this){return function(rxdata){return new Uint8Array(rxdata)[0]}}(this))};BaseComm.prototype.transData=function(txdata,receiver){var byte,dst,j,len,len1,src;if(txdata){src=new Uint8Array(txdata);dst=new Uint8Array(txdata.byteLength*2);len=0;for(j=0,len1=src.length;j<len1;j++){byte=src[j];if(byte===58||byte===61){dst[len]=61;len+=1;byte^=32}dst[len]=byte;len+=1}txdata=dst.buffer.slice(0,len)}return this._transSerial(txdata,receiver)};BaseComm.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("BaseComm",func,msg,data)}};BaseComm.prototype._transSerial=function(txdata,receiver){var promise,txsize,x;if(!this._connected){return Promise.reject(Error("Not connected"))}if(this._receiver){return Promise.reject(Error("Operation is in progress"))}promise=new Promise(function(_this){return function(resolve,reject){return _this._receiver=function(rxdata){var newArray,offset,ref,result;offset=((ref=_this._rxBuffer)!=null?ref.byteLength:void 0)||0;newArray=new Uint8Array(offset+rxdata.byteLength);if(_this._rxBuffer){newArray.set(new Uint8Array(_this._rxBuffer))}newArray.set(new Uint8Array(rxdata),offset);_this._rxBuffer=newArray.buffer;result=receiver(_this._rxBuffer,offset);if(result instanceof Error){_this._rxBuffer=null;_this._receiver=null;return reject(result)}if(result!=null){rxdata=_this._rxBuffer.slice(0,result);_this._rxBuffer=_this._rxBuffer.slice(result);_this._receiver=null;return resolve(rxdata)}}}}(this));txsize=(txdata!=null?txdata.byteLength:void 0)||0;return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=txsize,ref1=SERIAL_TX_MAX_LENGTH;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(_this){return function(sequence,pos){return sequence.then(function(){return new Promise(function(resolve,reject){var data,size;data=txdata.slice(pos,pos+SERIAL_TX_MAX_LENGTH);size=data.byteLength;return chrome.serial.send(_this._cid,data,function(writeInfo){var b,e;e=writeInfo.error;if(e!=null){return reject(Error(e))}b=writeInfo.bytesSent;if(b!==size){return reject(Error("bytesSent("+b+") != bytesRequested("+size+")"))}_this._log(1,"_transSerial","sent",new Uint8Array(data));if(!(SUCCESSIVE_TX_WAIT_MS>0)){return resolve()}return window.setTimeout(resolve,SUCCESSIVE_TX_WAIT_MS)})})})}}(this),Promise.resolve()).then(function(_this){return function(){if(!receiver){_this._receiver=null;return new ArrayBuffer(0)}_this._log(1,"_transSerial","wait",promise);return promise}}(this))};BaseComm.prototype._onReceiveHandler=function(info){if(!(info.connectionId===this._cid&&this._connected)){return}Promise.resolve().then(function(_this){return function(){if(_this._receiver){_this._receiver(info.data)}else{_this._log(1,"_onReceiveHandler","dropped",new Uint8Array(info.data))}}}(this))};BaseComm.prototype._onReceiveProcess=function(data){if(!this._receiver){this._log(1,"_onReceiveHandler","dropped",new Uint8Array(info.data));return}return this._processor=this._processor.then(function(_this){return function(){return _this._receiver(data)}}(this))};BaseComm.prototype._addRxBuffer=function(data){this._rxBuffers.push(data.slice(0));this._rxTotalLength+=data.byteLength};BaseComm.prototype._sliceRxBuffer=function(length){var array,partArray,partBuf,partLen,pos,rem;if(length>this._rxTotalLength){return null}array=new Uint8Array(length);pos=0;rem=length;while(rem>0){partBuf=this._rxBuffers[0];partLen=partBuf.byteLength;if(partLen<=rem){this._rxBuffers.shift()}else{partArray=new Uint8Array(partLen-rem);partArray.set(new Uint8Array(partBuf,rem));this._rxBuffers[0]=partArray.buffer;partLen=rem}array.set(new Uint8Array(partBuf,0,partLen),pos);pos+=partLen;rem-=partLen}this._rxTotalLength-=length;return array.buffer};BaseComm.prototype._onReceiveErrorHandler=function(info){var error;if(!(info.connectionId===this._cid&&this._connected)){return}error=""+info.error;if(SPLIT_EVENT_CONTEXT){window.setTimeout(function(_this){return function(){return _this._onReceiveErrorProcess(error)}}(this),0)}else{this._onReceiveErrorProcess(error)}};BaseComm.prototype._onReceiveErrorProcess=function(error){var queue;this.disconnect();this._rxBuffers=[];this._rxTotalLength=0;while(queue=this._rxQueue.shift()){queue.reject.call(void 0,Error("Disconnected because of "+error))}};return BaseComm}();Canarium.I2CComm=function(){var I2C_TIMEOUT_MS;null;I2CComm.verbosity=0;I2C_TIMEOUT_MS=1e3;function I2CComm(_base){this._base=_base;return}I2CComm.prototype.start=function(callback){var timeLimit;if(callback!=null){return invokeCallback(callback,this.start())}timeLimit=void 0;return Promise.resolve().then(function(_this){return function(){_this._log(1,"start","(start condition)");timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return tryPromise(timeLimit.left,function(){return _this._base.transCommand(59).then(function(response){if((response&48)!==48){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return _this._base.transCommand(27)}}(this)).then(function(_this){return function(){return _this._base.transCommand(11)}}(this)).then(function(_this){return function(){}}(this))};I2CComm.prototype.stop=function(callback){var timeLimit;if(callback!=null){return invokeCallback(callback,this.stop())}timeLimit=void 0;return Promise.resolve().then(function(_this){return function(){_this._log(1,"stop","(stop condition)");timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return _this._base.transCommand(11)}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(27).then(function(response){if((response&48)!==16){return Promise.reject()}})})}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._base.transCommand(59).then(function(response){if((response&48)!==48){return Promise.reject()}})})}}(this)).then(function(_this){return function(){if(_this._base.sendImmediate){return}return _this._base.transCommand(57)}}(this)).then(function(_this){return function(){}}(this))};I2CComm.prototype.read=function(ack,callback){var readData,timeLimit;if(callback!=null){return invokeCallback(callback,this.read(ack))}ack=!!ack;timeLimit=void 0;readData=0;return Promise.resolve().then(function(_this){return function(){timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return[7,6,5,4,3,2,1,0].reduce(function(promise,bitNum){return promise.then(function(){return tryPromise(timeLimit.left,function(){return _this._readBit()},1)}).then(function(bit){_this._log(2,"read","bit#"+bitNum+"="+bit);return readData|=bit<<bitNum})},Promise.resolve())}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){_this._log(2,"read",ack?"ACK":"NAK");return _this._writeBit(ack?0:1)},1)}}(this)).then(function(_this){return function(){_this._log(1,"read","data=0x"+readData.toString(16));return readData}}(this))};I2CComm.prototype.write=function(writebyte,callback){var timeLimit;if(callback!=null){return invokeCallback(callback,this.write(writebyte))}writebyte=parseInt(writebyte);timeLimit=void 0;return Promise.resolve().then(function(_this){return function(){_this._log(1,"write","data=0x"+writebyte.toString(16));timeLimit=new TimeLimit(I2C_TIMEOUT_MS);return[7,6,5,4,3,2,1,0].reduce(function(sequence,bitNum){var bit;bit=writebyte>>>bitNum&1;return sequence.then(function(){_this._log(2,"write","bit#"+bitNum+"="+bit);return tryPromise(timeLimit.left,function(){return _this._writeBit(bit)},1)})},Promise.resolve())}}(this)).then(function(_this){return function(){return tryPromise(timeLimit.left,function(){return _this._readBit()},1)}}(this)).then(function(_this){return function(bit){var ack;ack=bit===0;_this._log(2,"write",ack?"ACK":"NAK");return ack}}(this))};I2CComm.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("I2CComm",func,msg,data)}};I2CComm.prototype._readBit=function(){var bit,timeLimit;timeLimit=void 0;bit=0;return Promise.resolve().then(function(_this){return function(){timeLimit=new TimeLimit(I2C_TIMEOUT_MS);_this._log(3,"_readBit","setup,SCL->HiZ");return tryPromise(timeLimit.left,function(){return _this._base.transCommand(59).then(function(response){if((response&16)!==16){return Promise.reject()}if((response&32)===32){return bit=1}})})}}(this)).then(function(_this){return function(){_this._log(3,"_readBit","SCL->L");return _this._base.transCommand(43)}}(this)).then(function(_this){return function(){return bit}}(this))};I2CComm.prototype._writeBit=function(bit){var timeLimit;timeLimit=void 0;bit=(bit!==0?1:0)<<5;return Promise.resolve().then(function(_this){return function(){timeLimit=new TimeLimit(I2C_TIMEOUT_MS);_this._log(3,"_writeBit","setup");return _this._base.transCommand(11|bit)}}(this)).then(function(_this){return function(){_this._log(3,"_writeBit","SCL->HiZ");return tryPromise(timeLimit.left,function(){return _this._base.transCommand(27|bit).then(function(response){if((response&16)!==16){return Promise.reject()}})})}}(this)).then(function(_this){return function(){_this._log(3,"_writeBit","SCL->L");return _this._base.transCommand(43)}}(this)).then(function(_this){return function(){}}(this))};return I2CComm}();Canarium.AvsPackets=function(){null;AvsPackets.property("base",{get:function(){return this._base}});AvsPackets.verbosity=2;function AvsPackets(_base){this._base=_base;return}AvsPackets.prototype.transPacket=function(channel,txdata,rxsize){var byte,dst,eopFinder,header,j,len,len1,pushWithEscape,ref,src,totalRxLen;pushWithEscape=function(array,pos,byte){if(122<=byte&&byte<=125){array[pos++]=125;array[pos++]=byte^32;return pos}array[pos++]=byte;return pos};channel&=255;src=new Uint8Array(txdata);dst=new Uint8Array(txdata.byteLength*2+5);len=0;dst[len++]=124;len=pushWithEscape(dst,len,channel);dst[len++]=122;header=dst.subarray(0,len);ref=src.subarray(0,src.length-1);for(j=0,len1=ref.length;j<len1;j++){byte=ref[j];len=pushWithEscape(dst,len,byte)}dst[len++]=123;len=pushWithEscape(dst,len,src[src.length-1]);txdata=dst.buffer.slice(0,len);totalRxLen=rxsize+header.length+1;this._log(1,"transPacket","begin",{source:src,encoded:new Uint8Array(txdata)});eopFinder=function(_this){return function(rxdata,offset){var array,k,pos,ref1,ref2;array=new Uint8Array(rxdata);for(pos=k=ref1=offset,ref2=array.length;ref1<=ref2?k<ref2:k>ref2;pos=ref1<=ref2?++k:--k){if(array[pos-1]===123&&array[pos-0]!==125||array[pos-2]===123&&array[pos-1]===125){return pos+1}}}}(this);return this._base.transData(txdata,eopFinder).then(function(_this){return function(rxdata){var k,len2,pos,xor;src=new Uint8Array(rxdata);_this._log(1,"transPacket","recv",{encoded:src});if(src.subarray(0,header.length).join(",")!==header.join(",")){return Promise.reject(Error("Illegal packetize control bytes"))}src=src.subarray(header.length);dst=new Uint8Array(rxsize);pos=0;xor=0;for(k=0,len2=src.length;k<len2;k++){byte=src[k];if(pos===rxsize){return Promise.reject(Error("Received data is too large"))}if(byte===123){continue}if(byte===125){xor=32}else{dst[pos++]=byte^xor;xor=0}}if(pos<rxsize){return Promise.reject(Error("Received data is too small"))}_this._log(1,"transPacket","end",{decoded:dst});return dst.buffer}}(this))};AvsPackets.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("AvsPackets",func,msg,data)}};return AvsPackets}();Canarium.AvmTransactions=function(){var AVM_TRANS_MAX_BYTES;null;AvmTransactions.verbosity=2;AVM_TRANS_MAX_BYTES=32768;function AvmTransactions(_avs,_channel){this._avs=_avs;this._channel=_channel;this._lastAction=Promise.resolve();return}AvmTransactions.prototype.read=function(address,bytenum,callback){if(callback!=null){return invokeCallback(callback,this.read(address,bytenum))}return this._queue(function(_this){return function(){var dest,x;_this._log(1,"read","begin(address="+hexDump(address)+")");if(!_this._avs.base.configured){return Promise.reject("Device is not configured")}dest=new Uint8Array(bytenum);return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=bytenum,ref1=AVM_TRANS_MAX_BYTES;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(sequence,pos){return sequence.then(function(){var partialSize;partialSize=Math.min(bytenum-pos,AVM_TRANS_MAX_BYTES);_this._log(2,"read","partial(offset="+hexDump(pos)+",size="+hexDump(partialSize)+")");return _this._trans(20,address+pos,void 0,partialSize).then(function(partialData){return dest.set(new Uint8Array(partialData),pos)})})},Promise.resolve()).then(function(){_this._log(1,"read","end",dest);return dest.buffer})}}(this))};AvmTransactions.prototype.write=function(address,writedata,callback){var src;if(callback!=null){return invokeCallback(callback,this.write(address,writedata))}src=new Uint8Array(writedata.slice(0));return this._queue(function(_this){return function(){var x;_this._log(1,"write","begin(address="+hexDump(address)+")",src);if(!_this._avs.base.configured){return Promise.reject("Device is not configured")}return function(){var j,ref,ref1,results;results=[];for(x=j=0,ref=src.byteLength,ref1=AVM_TRANS_MAX_BYTES;ref1>0?j<ref:j>ref;x=j+=ref1){results.push(x)}return results}().reduce(function(sequence,pos){return sequence.then(function(){var partialData;partialData=src.subarray(pos,pos+AVM_TRANS_MAX_BYTES);_this._log(2,"write","partial(offset="+hexDump(pos)+")",partialData);return _this._trans(4,address+pos,partialData,void 0)})},Promise.resolve()).then(function(){_this._log(1,"write","end")})}}(this))};AvmTransactions.prototype.iord=function(address,offset,callback){if(callback!=null){return invokeCallback(callback,this.iord(address,offset))}return this._queue(function(_this){return function(){_this._log(1,"iord","begin(address="+hexDump(address)+"+"+offset+")");if(!_this._avs.base.configured){return Promise.reject("Device is not configured")}return _this._trans(16,(address&4294967292)+(offset<<2),void 0,4).then(function(rxdata){var readData,src;src=new Uint8Array(rxdata);readData=src[3]<<24|src[2]<<16|src[1]<<8|src[0]<<0;_this._log(1,"iord","end",readData);return readData})}}(this))};AvmTransactions.prototype.iowr=function(address,offset,writedata,callback){if(callback!=null){return invokeCallback(callback,this.iowr(address,offset,writedata))}return this._queue(function(_this){return function(){var src;_this._log(1,"iowr","begin(address="+hexDump(address)+"+"+offset+")",writedata);if(!_this._avs.base.configured){return Promise.reject("Device is not configured")}src=new Uint8Array(4);src[0]=writedata>>>0&255;src[1]=writedata>>>8&255;src[2]=writedata>>>16&255;src[3]=writedata>>>24&255;return _this._trans(0,(address&4294967292)+(offset<<2),src,void 0).then(function(){_this._log(1,"iowr","end")})}}(this))};AvmTransactions.prototype.option=function(option,callback){if(callback!=null){return invokeCallback(callback,this.option(option))}return this._queue(function(_this){return function(){return _this._avs.base.option(option)}}(this))};AvmTransactions.prototype._queue=function(action){return new Promise(function(_this){return function(resolve,reject){return _this._lastAction=_this._lastAction.then(action).then(resolve,reject)}}(this))};AvmTransactions.prototype._log=function(lvl,func,msg,data){if(this.constructor.verbosity>=lvl){Canarium._log("AvmTransactions",func,msg,data)}};AvmTransactions.prototype._trans=function(transCode,address,txdata,rxsize){var len,pkt;len=(txdata!=null?txdata.byteLength:void 0)||rxsize;pkt=new Uint8Array(8+((txdata!=null?txdata.byteLength:void 0)||0));pkt[0]=transCode;pkt[1]=0;pkt[2]=len>>>8&255;pkt[3]=len>>>0&255;pkt[4]=address>>>24&255;pkt[5]=address>>>16&255;pkt[6]=address>>>8&255;pkt[7]=address>>>0&255;if(txdata){pkt.set(txdata,8)}this._log(2,"_trans","send",pkt);return this._avs.transPacket(this._channel,pkt.buffer,rxsize||4).then(function(_this){return function(rxdata){var res;_this._log(2,"_trans","recv",new Uint8Array(rxdata));if(rxsize){if(rxdata.byteLength!==rxsize){return Promise.reject(Error("Received data length does not match"))}return rxdata}res=new Uint8Array(rxdata);if(!(res[0]===pkt[0]^128&&res[2]===pkt[2]&&res[3]===pkt[3])){return Promise.reject(Error("Illegal write response"))}}}(this))};return AvmTransactions}();if(oldProperty!=null){Function.prototype.property=oldProperty}else{delete Function.prototype.property}this.Canarium=Canarium}).call(this);